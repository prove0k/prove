<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K1 Âø´Ê®ÇÂ≠∏Ëã±Ë™û A-H</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --scale-icon: 1;
            --scale-text: 1;
            --base-icon-size: 3rem; /* Â∞çÊáâ text-5xl */
            --base-text-size: 1.25rem; /* Â∞çÊáâ text-xl */
        }

        body {
            font-family: 'Zen Maru Gothic', 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            background-image: radial-gradient(#dbeafe 2px, transparent 2px);
            background-size: 30px 30px;
            user-select: none; /* Prevent text selection during game */
        }

        /* Dynamic Sizing Classes */
        .dynamic-icon {
            font-size: calc(var(--base-icon-size) * var(--scale-icon)) !important;
            line-height: 1.2;
            transition: font-size 0.2s;
        }
        .dynamic-text {
            font-size: calc(var(--base-text-size) * var(--scale-text)) !important;
            line-height: 1.4;
            transition: font-size 0.2s;
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:active {
            transform: scale(0.95);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .item-icon {
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.1));
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Game Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.4s ease-in-out;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop {
            animation: pop 0.3s ease-out;
        }
        
        /* Game Card Styles */
        .game-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .game-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.05);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .game-card.matched {
            border-color: #22c55e;
            background-color: #dcfce7;
            opacity: 0.6;
            pointer-events: none;
            transform: scale(0.95);
        }
        .game-card.wrong {
            border-color: #ef4444;
            background-color: #fee2e2;
        }
        .game-card.correct-highlight {
            border-color: #22c55e !important;
            background-color: #dcfce7 !important;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        /* Speaker Button Pulse */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .pulse-btn {
            animation: pulse-ring 2s infinite;
        }
        
        /* Toggle Switch */
        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mode-btn {
            background-color: white;
            color: #4b5563;
        }
        
        /* Fade in animation for filtering */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Settings Modal */
        input[type=range] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d1d5db;
            outline: none;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Header / Navigation -->
    <header class="bg-white shadow-lg sticky top-0 z-50 border-b-4 border-yellow-400">
        <div class="max-w-5xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="location.reload()">
                    <span class="text-4xl">üöå</span>
                    <h1 class="text-2xl md:text-3xl font-bold text-blue-600 tracking-wider">K1 Âø´Ê®ÇÂ≠∏Ëã±Ë™û</h1>
                </div>
                
                <div class="flex items-center gap-3 flex-wrap justify-center">
                    <!-- Mode Switcher -->
                    <div class="flex bg-gray-100 p-1 rounded-full shadow-inner">
                        <button onclick="switchMode('learn')" id="btn-learn" class="mode-btn active px-4 md:px-5 py-2 rounded-full font-bold text-lg transition-all flex items-center gap-2">
                            <span>üìñ</span> <span class="hidden md:inline">Â≠∏Áøí</span>
                        </button>
                        <button onclick="switchMode('game')" id="btn-game" class="mode-btn px-4 md:px-5 py-2 rounded-full font-bold text-lg transition-all flex items-center gap-2">
                            <span>üéÆ</span> <span class="hidden md:inline">ÈÖçÂ∞ç</span>
                        </button>
                        <button onclick="switchMode('listen')" id="btn-listen" class="mode-btn px-4 md:px-5 py-2 rounded-full font-bold text-lg transition-all flex items-center gap-2">
                            <span>üëÇ</span> <span class="hidden md:inline">ËÅΩÂäõ</span>
                        </button>
                    </div>

                    <!-- Settings Button -->
                    <button onclick="toggleSettings()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-3 rounded-full transition shadow-sm border-2 border-gray-200" title="Ë®≠ÂÆöÂ§ßÂ∞è">
                        <span class="text-xl">‚öôÔ∏è</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Navigation Bar (Only for Learn Mode) -->
        <div id="nav-bar-container" class="bg-yellow-100 py-2 overflow-x-auto transition-all duration-300">
            <div class="flex space-x-2 px-4 min-w-max justify-center md:justify-start items-center" id="nav-buttons">
                <!-- Nav buttons generated by JS -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 py-8">
        
        <!-- LEARN VIEW -->
        <div id="learn-view" class="space-y-8">
            <div id="card-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Cards generated by JS -->
            </div>
        </div>

        <!-- PAIRING GAME VIEW -->
        <div id="game-view" class="hidden">
            <div class="text-center mb-8">
                <div class="inline-block bg-white px-8 py-4 rounded-3xl shadow-lg border-4 border-indigo-200">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-2">ÈÖçÂ∞çÂ∞èÈÅäÊà≤</h2>
                    <p class="text-gray-500">ÈªûÈÅ∏‰∏ÄÂÄãËã±ÊñáÂñÆÂ≠óÔºåÂÜçÈªûÈÅ∏Â∞çÊáâÁöÑÂúñÁâáÔºÅ</p>
                    <div class="mt-4 flex justify-center gap-4 text-xl font-bold">
                        <div class="text-green-500">ÂæóÂàÜ: <span id="score">0</span></div>
                    </div>
                </div>
            </div>

            <div id="game-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-3xl mx-auto">
                <!-- Game cards will be injected here -->
            </div>

            <div id="game-over" class="hidden text-center mt-8">
                <div class="text-6xl mb-4 animate-bounce">üéâ</div>
                <h3 class="text-3xl font-bold text-purple-600 mb-4">Â•ΩÊ£íÂñîÔºÅÂÖ®ÈÉ®Á≠îÂ∞ç‰∫ÜÔºÅ</h3>
                <button onclick="initGame()" class="bg-yellow-400 hover:bg-yellow-500 text-white text-xl px-8 py-4 rounded-full font-bold shadow-lg transition transform hover:scale-110 border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1">
                    ÂÜç‰æÜ‰∏ÄÂ±Ä ‚ûú
                </button>
            </div>
        </div>

        <!-- LISTENING GAME VIEW (New) -->
        <div id="listen-view" class="hidden">
            <div class="max-w-2xl mx-auto text-center">
                
                <!-- Controls for Listen Mode -->
                <div class="flex justify-center gap-4 mb-6">
                    <label class="inline-flex items-center cursor-pointer bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200 hover:bg-gray-50 transition select-none">
                        <input type="checkbox" id="chk-show-text" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" checked onchange="toggleListenDisplay()">
                        <span class="ml-2 text-gray-700 font-bold">È°ØÁ§∫ÂñÆÂ≠ó</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200 hover:bg-gray-50 transition select-none">
                        <input type="checkbox" id="chk-show-icon" class="w-5 h-5 text-green-600 rounded focus:ring-green-500" checked onchange="toggleListenDisplay()">
                        <span class="ml-2 text-gray-700 font-bold">È°ØÁ§∫ÂúñÁâá</span>
                    </label>
                </div>

                <!-- Question Area -->
                <div class="bg-white rounded-3xl p-8 shadow-xl border-b-8 border-blue-200 mb-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-400"></div>
                    
                    <h2 class="text-2xl font-bold text-gray-600 mb-6">‰ªîÁ¥∞ËÅΩÔºåÈÄôÊòØ‰ªÄÈ∫ºÔºü</h2>
                    
                    <button onclick="playTargetSound()" class="w-32 h-32 rounded-full bg-blue-500 hover:bg-blue-600 text-white shadow-lg flex items-center justify-center mx-auto transition transform active:scale-95 pulse-btn mb-4">
                        <span class="text-6xl">üîä</span>
                    </button>
                    
                    <p class="text-sm text-gray-400">ÈªûÊìäÂñáÂè≠ÂÜçËÅΩ‰∏ÄÊ¨°</p>
                </div>

                <!-- Options Grid -->
                <div id="listen-options" class="grid grid-cols-3 gap-4 md:gap-8">
                    <!-- Options injected by JS -->
                </div>
                
                <!-- Listen Game Feedback Area -->
                <div id="listen-feedback" class="mt-8 h-16">
                    <!-- Feedback messages appear here -->
                </div>

            </div>
        </div>

    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm transition-opacity" onclick="toggleSettings()"></div>
        
        <!-- Content -->
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 relative transform transition-all scale-100 animate-[pop_0.3s_ease-out]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700 flex items-center gap-2">
                    <span>‚öôÔ∏è</span> Ë®≠ÂÆöÈ°ØÁ§∫
                </h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- Icon Size Control -->
                <div class="bg-blue-50 p-4 rounded-2xl">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-blue-600">ÂúñÊ°àÂ§ßÂ∞è</label>
                        <span class="text-xs bg-blue-200 text-blue-700 px-2 py-0.5 rounded-full">Icon Size</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üçé</span>
                        <input type="range" min="0.8" max="2.0" step="0.1" value="1" id="icon-slider" oninput="updateSize('icon', this.value)">
                        <span class="text-3xl">üçé</span>
                    </div>
                </div>

                <!-- Text Size Control -->
                <div class="bg-green-50 p-4 rounded-2xl">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-green-600">ÊñáÂ≠óÂ§ßÂ∞è</label>
                        <span class="text-xs bg-green-200 text-green-700 px-2 py-0.5 rounded-full">Text Size</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold text-gray-500">Aa</span>
                        <input type="range" min="0.8" max="2.0" step="0.1" value="1" id="text-slider" oninput="updateSize('text', this.value)">
                        <span class="text-2xl font-bold text-gray-500">Aa</span>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="toggleSettings()" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-600 transition transform active:scale-95 w-full">
                    ÂÆåÊàê
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-gray-500 py-8 text-sm">
        <p>K1 English Learning Material ‚Ä¢ Design for Kids</p>
    </footer>

    <script>
        const letters = [
            {
                letter: 'A',
                lower: 'a',
                color: 'bg-red-100 border-red-300 text-red-600',
                items: [
                    { word: 'apple', zh: 'ËòãÊûú', icon: 'üçé' },
                    { word: 'ant', zh: 'ËûûËüª', icon: 'üêú' },
                    { word: 'axe', zh: 'ÊñßÈ†≠', icon: 'ü™ì' }
                ]
            },
            {
                letter: 'B',
                lower: 'b',
                color: 'bg-yellow-100 border-yellow-300 text-yellow-600',
                items: [
                    { word: 'boy', zh: 'Áî∑Â≠©', icon: 'üë¶' },
                    { word: 'banana', zh: 'È¶ôËïâ', icon: 'üçå' },
                    { word: 'ball', zh: 'ÁêÉ', icon: '‚öΩ' }
                ]
            },
            {
                letter: 'C',
                lower: 'c',
                color: 'bg-blue-100 border-blue-300 text-blue-600',
                items: [
                    { word: 'cake', zh: 'ËõãÁ≥ï', icon: 'üç∞' },
                    { word: 'cat', zh: 'Ë≤ì', icon: 'üê±' },
                    { word: 'car', zh: 'Ëªä', icon: 'üöó' }
                ]
            },
            {
                letter: 'D',
                lower: 'd',
                color: 'bg-green-100 border-green-300 text-green-600',
                items: [
                    { word: 'dog', zh: 'Áãó', icon: 'üê∂' },
                    { word: 'door', zh: 'ÈñÄ', icon: 'üö™' },
                    { word: 'doll', zh: 'Ê¥ãÂ®ÉÂ®É', icon: 'üß∏' }
                ]
            },
            {
                letter: 'E',
                lower: 'e',
                color: 'bg-purple-100 border-purple-300 text-purple-600',
                items: [
                    { word: 'egg', zh: 'Ëõã', icon: 'ü•ö' },
                    { word: 'elephant', zh: 'Â§ßË±°', icon: 'üêò' },
                    { word: 'ear', zh: 'ËÄ≥Êúµ', icon: 'üëÇ' }
                ]
            },
            {
                letter: 'F',
                lower: 'f',
                color: 'bg-orange-100 border-orange-300 text-orange-600',
                items: [
                    { word: 'fish', zh: 'È≠ö', icon: 'üêü' },
                    { word: 'frog', zh: 'ÈùíËõô', icon: 'üê∏' },
                    { word: 'food', zh: 'È£üÁâ©', icon: 'üç±' }
                ]
            },
            {
                letter: 'G',
                lower: 'g',
                color: 'bg-teal-100 border-teal-300 text-teal-600',
                items: [
                    { word: 'girl', zh: 'Â•≥Â≠©', icon: 'üëß' },
                    { word: 'goat', zh: 'Â±±Áæä', icon: 'üêê' },
                    { word: 'grass', zh: 'Ëçâ', icon: 'üåø' }
                ]
            },
            {
                letter: 'H',
                lower: 'h',
                color: 'bg-pink-100 border-pink-300 text-pink-600',
                items: [
                    { word: 'hand', zh: 'Êâã', icon: '‚úã' },
                    { word: 'head', zh: 'È†≠', icon: 'üó£Ô∏è' },
                    { word: 'happy', zh: 'Âø´Ê®Ç', icon: 'üòÑ' }
                ]
            }
        ];

        // --- Common Functions ---

        function speak(text, rate = 0.8) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = rate;
            utterance.pitch = 1.1;
            const voices = window.speechSynthesis.getVoices();
            const enVoice = voices.find(v => v.lang.startsWith('en-US') && !v.name.includes('Google')) || voices.find(v => v.lang.startsWith('en'));
            if (enVoice) utterance.voice = enVoice;
            window.speechSynthesis.speak(utterance);
        }

        // --- Settings Logic ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function updateSize(type, value) {
            const root = document.documentElement;
            if (type === 'icon') {
                root.style.setProperty('--scale-icon', value);
            } else if (type === 'text') {
                root.style.setProperty('--scale-text', value);
            }
        }
        
        function getAllItems() {
            let allItems = [];
            letters.forEach(l => {
                l.items.forEach(item => {
                    allItems.push({...item, id: item.word}); 
                });
            });
            return allItems;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Learning View Logic ---

        function renderLearnApp() {
            const container = document.getElementById('card-container');
            const nav = document.getElementById('nav-buttons');
            container.innerHTML = ''; // Clear previous
            nav.innerHTML = ''; // Clear previous
            
            // 1. Add "ALL" Button
            const allBtn = document.createElement('button');
            allBtn.className = `nav-btn w-12 h-10 rounded-full font-bold text-sm border-2 border-gray-300 bg-white hover:bg-gray-100 text-gray-600 flex-shrink-0 shadow-sm transition-all active:scale-95 ring-2 ring-blue-400 ring-offset-2 transform scale-110`; // Default active
            allBtn.innerText = 'ALL';
            allBtn.dataset.letter = 'ALL';
            allBtn.onclick = () => filterCards('ALL');
            nav.appendChild(allBtn);
            
            letters.forEach(data => {
                const navBtn = document.createElement('button');
                navBtn.className = `nav-btn w-10 h-10 rounded-full font-bold text-lg border-2 ${data.color.replace('bg-', 'border-').replace('text-', 'text-')} bg-white hover:bg-gray-50 flex-shrink-0 shadow-sm transition-all active:scale-95`;
                navBtn.innerText = data.letter;
                navBtn.dataset.letter = data.letter;
                navBtn.onclick = () => filterCards(data.letter);
                nav.appendChild(navBtn);

                const card = document.createElement('div');
                card.id = `section-${data.letter}`;
                card.dataset.letter = data.letter;
                card.className = `letter-section rounded-3xl border-4 ${data.color.replace('bg-', 'border-').split(' ')[1]} bg-white shadow-xl overflow-hidden fade-in`;

                const header = document.createElement('div');
                header.className = `${data.color} p-4 text-center cursor-pointer transition hover:brightness-95`;
                header.onclick = () => speak(`${data.letter}, ${data.lower}, ${data.letter}`);
                header.innerHTML = `
                    <div class="text-6xl font-black tracking-widest drop-shadow-sm inline-block floating">
                        ${data.letter}${data.lower}
                    </div>
                    <div class="text-sm font-bold opacity-70 mt-1">ÈªûÊìäËÅΩÁôºÈü≥</div>
                `;
                card.appendChild(header);

                const grid = document.createElement('div');
                grid.className = "p-4 grid grid-cols-3 gap-4";

                data.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "flex flex-col items-center justify-center p-2 rounded-xl bg-gray-50 border-2 border-gray-100 card-hover cursor-pointer h-full";
                    itemDiv.onclick = () => speak(item.word);
                    
                    itemDiv.innerHTML = `
                        <div class="mb-2 item-icon dynamic-icon">${item.icon}</div>
                        <div class="font-bold text-gray-700 capitalize select-none dynamic-text">${item.word}</div>
                        <div class="text-xs text-gray-400 font-medium">${item.zh}</div>
                    `;
                    grid.appendChild(itemDiv);
                });

                card.appendChild(grid);
                container.appendChild(card);
            });
        }

        function filterCards(filter) {
            const sections = document.querySelectorAll('.letter-section');
            const buttons = document.querySelectorAll('.nav-btn');

            sections.forEach(sec => {
                if (filter === 'ALL' || sec.dataset.letter === filter) {
                    sec.classList.remove('hidden');
                    sec.classList.add('fade-in');
                } else {
                    sec.classList.add('hidden');
                    sec.classList.remove('fade-in');
                }
            });

            buttons.forEach(btn => {
                if (btn.dataset.letter === filter) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400', 'scale-110');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'scale-110');
                }
            });
            
            if (filter !== 'ALL') {
                const letterData = letters.find(l => l.letter === filter);
                if (letterData) {
                    speak(`${letterData.letter}`);
                }
            }
        }

        // --- Pairing Game Logic ---

        let gameState = {
            selectedCard: null,
            matchesFound: 0,
            totalPairs: 4,
            isLocked: false
        };

        function initGame() {
            const grid = document.getElementById('game-grid');
            const gameOverDiv = document.getElementById('game-over');
            grid.innerHTML = '';
            gameOverDiv.classList.add('hidden');
            
            gameState.selectedCard = null;
            gameState.matchesFound = 0;
            gameState.isLocked = false;
            document.getElementById('score').innerText = '0';

            const allItems = getAllItems();
            const shuffledItems = shuffle(allItems).slice(0, gameState.totalPairs);
            
            let gameCards = [];
            shuffledItems.forEach(item => {
                gameCards.push({
                    id: item.word,
                    type: 'text',
                    content: item.word,
                    display: `<span class="font-bold text-indigo-600 capitalize dynamic-text">${item.word}</span>`,
                    rawWord: item.word
                });
                gameCards.push({
                    id: item.word,
                    type: 'icon',
                    content: item.icon,
                    display: `<span class="item-icon dynamic-icon">${item.icon}</span>`,
                    rawWord: item.word
                });
            });

            shuffle(gameCards);

            gameCards.forEach(cardData => {
                const cardEl = document.createElement('div');
                cardEl.className = 'game-card bg-white border-b-4 border-gray-200 rounded-2xl min-h-[8rem] p-2 flex items-center justify-center shadow-md active:scale-95 overflow-hidden';
                cardEl.dataset.id = cardData.id;
                cardEl.dataset.word = cardData.rawWord;
                cardEl.innerHTML = cardData.display;
                
                cardEl.onclick = () => handleCardClick(cardEl, cardData);
                grid.appendChild(cardEl);
            });
        }

        function handleCardClick(element, data) {
            if (gameState.isLocked) return;
            if (element.classList.contains('matched')) return;
            if (element === gameState.selectedCard) return;

            speak(data.rawWord);

            element.classList.add('selected');

            if (!gameState.selectedCard) {
                gameState.selectedCard = element;
            } else {
                gameState.isLocked = true;
                const prevElement = gameState.selectedCard;
                const prevId = prevElement.dataset.id;
                const currentId = data.id;

                if (prevId === currentId) {
                    setTimeout(() => {
                        element.classList.remove('selected');
                        prevElement.classList.remove('selected');
                        element.classList.add('matched', 'pop');
                        prevElement.classList.add('matched', 'pop');
                        
                        gameState.matchesFound++;
                        document.getElementById('score').innerText = gameState.matchesFound * 10;
                        gameState.selectedCard = null;
                        gameState.isLocked = false;

                        if (gameState.matchesFound === gameState.totalPairs) {
                            setTimeout(() => {
                                document.getElementById('game-over').classList.remove('hidden');
                                speak("Wonderful! You did it!");
                            }, 500);
                        }
                    }, 500);
                } else {
                    setTimeout(() => {
                        element.classList.add('wrong', 'shake');
                        prevElement.classList.add('wrong', 'shake');
                    }, 500);

                    setTimeout(() => {
                        element.classList.remove('selected', 'wrong', 'shake');
                        prevElement.classList.remove('selected', 'wrong', 'shake');
                        gameState.selectedCard = null;
                        gameState.isLocked = false;
                    }, 1200);
                }
            }
        }

        // --- Listening Game Logic (NEW) ---
        
        let listenState = {
            target: null,
            isLocked: false
        };

        function toggleListenDisplay() {
            const showText = document.getElementById('chk-show-text').checked;
            const showIcon = document.getElementById('chk-show-icon').checked;
            
            const icons = document.querySelectorAll('.listen-icon');
            const texts = document.querySelectorAll('.listen-text');
            
            icons.forEach(el => {
                if(showIcon) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            
            texts.forEach(el => {
                if(showText) {
                    el.classList.remove('opacity-0');
                    el.classList.remove('invisible');
                } else {
                    // Only hide if not already answered correctly (which reveals it)
                    // But for simplicity, we just follow the toggle unless locked?
                    // Let's strict follow toggle, but 'checkListeningAnswer' might force reveal.
                    // Actually, if I uncheck 'Show Text', it should hide even if previously revealed? 
                    // Let's keep it simple: Toggle affects visibility directly.
                    el.classList.add('invisible'); 
                }
            });
        }

        function initListeningGame() {
            const feedbackDiv = document.getElementById('listen-feedback');
            const optionsDiv = document.getElementById('listen-options');
            feedbackDiv.innerHTML = ''; // clear previous feedback
            
            // Get current toggle states
            const showText = document.getElementById('chk-show-text').checked;
            const showIcon = document.getElementById('chk-show-icon').checked;

            // 1. Pick random target
            const allItems = getAllItems();
            const target = allItems[Math.floor(Math.random() * allItems.length)];
            listenState.target = target;
            listenState.isLocked = false;

            // 2. Pick 2 distractors (ensure unique)
            let distractors = [];
            while (distractors.length < 2) {
                let d = allItems[Math.floor(Math.random() * allItems.length)];
                if (d.word !== target.word && !distractors.find(x => x.word === d.word)) {
                    distractors.push(d);
                }
            }

            // 3. Combine and Shuffle
            const options = shuffle([target, ...distractors]);

            // 4. Render
            optionsDiv.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'bg-white border-4 border-gray-100 rounded-2xl p-4 flex flex-col items-center justify-center shadow-md hover:border-blue-200 transition transform active:scale-95 h-32 md:h-40';
                
                // Visibility classes based on checkboxes
                const iconClass = showIcon ? '' : 'hidden';
                // For text: if showText is true, we show it. If false, we use 'invisible' (takes up space but not seen)
                const textClass = showText ? '' : 'invisible';

                btn.innerHTML = `
                    <div class="text-5xl item-icon dynamic-icon mb-2 listen-icon ${iconClass}">${opt.icon}</div>
                    <div class="text-gray-400 text-2xl md:text-3xl font-bold capitalize dynamic-text listen-text ${textClass}">${opt.word}</div>
                `;
                btn.onclick = () => checkListeningAnswer(opt, btn);
                optionsDiv.appendChild(btn);
            });

            // 5. Auto play sound after brief delay
            setTimeout(() => playTargetSound(), 600);
        }

        function playTargetSound() {
            if (listenState.target) {
                speak(listenState.target.word);
            }
        }

        function checkListeningAnswer(selected, btnElement) {
            if (listenState.isLocked) return;

            const feedbackDiv = document.getElementById('listen-feedback');
            const textEl = btnElement.querySelector('.listen-text');

            if (selected.word === listenState.target.word) {
                // Correct
                listenState.isLocked = true;
                btnElement.classList.add('correct-highlight', 'pop');
                
                // Always reveal text on correct answer (remove invisible/opacity issues)
                textEl.classList.remove('invisible', 'opacity-0');
                textEl.classList.add('text-green-600');

                feedbackDiv.innerHTML = `
                    <div class="text-green-500 font-bold text-xl flex items-center justify-center gap-2 animate-bounce">
                        <span>üéâ</span> Yes! It's a ${selected.word}!
                    </div>
                `;
                speak("Yes! " + selected.word + ". Great job!");

                setTimeout(() => {
                    initListeningGame();
                }, 2500);

            } else {
                // Wrong
                btnElement.classList.add('wrong', 'shake');
                feedbackDiv.innerHTML = `<div class="text-red-400 font-bold text-lg">Try again!</div>`;
                speak("Oops, try again!");
                
                setTimeout(() => {
                    btnElement.classList.remove('wrong', 'shake');
                    feedbackDiv.innerHTML = '';
                }, 1000);
            }
        }

        // --- UI Switching ---

        function switchMode(mode) {
            const learnView = document.getElementById('learn-view');
            const gameView = document.getElementById('game-view');
            const listenView = document.getElementById('listen-view');
            
            const btnLearn = document.getElementById('btn-learn');
            const btnGame = document.getElementById('btn-game');
            const btnListen = document.getElementById('btn-listen');
            
            const navBar = document.getElementById('nav-bar-container');

            // Reset All
            [learnView, gameView, listenView].forEach(v => v.classList.add('hidden'));
            [btnLearn, btnGame, btnListen].forEach(b => b.classList.remove('active'));
            navBar.classList.add('hidden'); // Default hide

            if (mode === 'learn') {
                learnView.classList.remove('hidden');
                btnLearn.classList.add('active');
                navBar.classList.remove('hidden');
                navBar.style.height = 'auto';
                navBar.style.opacity = '1';
            } else if (mode === 'game') {
                gameView.classList.remove('hidden');
                btnGame.classList.add('active');
                initGame();
            } else if (mode === 'listen') {
                listenView.classList.remove('hidden');
                btnListen.classList.add('active');
                initListeningGame();
            }
        }

        window.speechSynthesis.onvoiceschanged = () => {};
        renderLearnApp();

    </script>
</body>
</html>